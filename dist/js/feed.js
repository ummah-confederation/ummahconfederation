class IndexedDBCache{constructor(t="ummah-cache",e="responses",n=1){this.dbName=t,this.storeName=e,this.version=n,this.db=null}async init(){return this.db?this.db:new Promise((t,e)=>{const n=indexedDB.open(this.dbName,this.version);n.onerror=()=>e(new Error(`Failed to open database: ${n.error}`)),n.onsuccess=()=>{this.db=n.result,t(this.db)},n.onupgradeneeded=t=>{const e=t.target.result;if(!e.objectStoreNames.contains(this.storeName)){const t=e.createObjectStore(this.storeName,{keyPath:"key"});t.createIndex("timestamp","timestamp",{unique:!1}),t.createIndex("ttl","ttl",{unique:!1})}}})}async get(t){try{const e=await this.init();return new Promise((n,a)=>{const i=e.transaction([this.storeName],"readonly").objectStore(this.storeName).get(t);i.onsuccess=()=>{const e=i.result;if(!e)return void n(null);Date.now()-e.timestamp<e.ttl?n(e.value):(this.delete(t).catch(console.warn),n(null))},i.onerror=()=>a(new Error(`Failed to get from cache: ${i.error}`))})}catch(t){return null}}async set(t,e,n=3e5){try{const a=await this.init();return new Promise((i,r)=>{const s=a.transaction([this.storeName],"readwrite"),o=s.objectStore(this.storeName),c={key:t,value:e,timestamp:Date.now(),ttl:n},l=o.put(c);l.onsuccess=()=>i(),l.onerror=()=>r(new Error(`Failed to set cache: ${l.error}`)),s.oncomplete=()=>i(),s.onerror=()=>r(new Error(`Transaction failed: ${s.error}`))})}catch(t){}}async getOrFetch(t,e,n){const a=await this.get(t);if(null!==a)return a;const i=await e();return await this.set(t,i,n),i}async getOrFetchStale(t,e,n,a=.8*n){try{const i=await this.init();return new Promise((r,s)=>{const o=i.transaction([this.storeName],"readonly").objectStore(this.storeName).get(t);o.onsuccess=()=>{const i=o.result;if(!i)return void e().then(e=>{this.set(t,e,n).catch(console.warn),r(e)}).catch(s);const c=Date.now()-i.timestamp;c<i.ttl?(c>a&&this.refreshInBackground(t,e,n),r(i.value)):(this.delete(t).catch(console.warn),e().then(e=>{this.set(t,e,n).catch(console.warn),r(e)}).catch(s))},o.onerror=()=>{e().then(e=>{this.set(t,e,n).catch(console.warn),r(e)}).catch(s)}})}catch(t){return e()}}async refreshInBackground(t,e,n){try{const a=await e();await this.set(t,a,n)}catch(t){}}async delete(t){try{const e=await this.init();return new Promise((n,a)=>{const i=e.transaction([this.storeName],"readwrite"),r=i.objectStore(this.storeName).delete(t);r.onsuccess=()=>n(),r.onerror=()=>a(new Error(`Failed to delete from cache: ${r.error}`)),i.oncomplete=()=>n(),i.onerror=()=>a(new Error(`Transaction failed: ${i.error}`))})}catch(t){}}async clear(){try{const t=await this.init();return new Promise((e,n)=>{const a=t.transaction([this.storeName],"readwrite"),i=a.objectStore(this.storeName).clear();i.onsuccess=()=>e(),i.onerror=()=>n(new Error(`Failed to clear cache: ${i.error}`)),a.oncomplete=()=>e(),a.onerror=()=>n(new Error(`Transaction failed: ${a.error}`))})}catch(t){}}async clearExpired(){try{const t=await this.init();return new Promise((e,n)=>{const a=t.transaction([this.storeName],"readwrite").objectStore(this.storeName).index("timestamp").openCursor();let i=0;const r=Date.now();a.onsuccess=t=>{const n=t.target.result;if(n){const t=n.value;r-t.timestamp>=t.ttl&&(n.delete(),i++),n.continue()}else e(i)},a.onerror=()=>n(new Error(`Failed to clear expired: ${a.error}`))})}catch(t){return 0}}async keys(){try{const t=await this.init();return new Promise((e,n)=>{const a=t.transaction([this.storeName],"readonly").objectStore(this.storeName).getAllKeys();a.onsuccess=()=>e(a.result),a.onerror=()=>n(new Error(`Failed to get keys: ${a.error}`))})}catch(t){return[]}}async getStats(){try{const t=await this.init();return new Promise((e,n)=>{const a=t.transaction([this.storeName],"readonly").objectStore(this.storeName).getAll();a.onsuccess=()=>{const t=a.result,n=Date.now();let i=0,r=0,s=0;t.forEach(t=>{const e=JSON.stringify(t).length;s+=e,n-t.timestamp<t.ttl?i++:r++}),e({totalEntries:t.length,validEntries:i,expiredEntries:r,totalBytes:s,totalKB:(s/1024).toFixed(2),avgEntrySize:t.length>0?(s/t.length).toFixed(2):0})},a.onerror=()=>n(new Error(`Failed to get stats: ${a.error}`))})}catch(t){return{totalEntries:0,validEntries:0,expiredEntries:0,totalBytes:0,totalKB:0,avgEntrySize:0}}}async close(){this.db&&(this.db.close(),this.db=null)}async deleteDatabase(){return await this.close(),new Promise((t,e)=>{const n=indexedDB.deleteDatabase(this.dbName);n.onsuccess=()=>t(),n.onerror=()=>e(new Error(`Failed to delete database: ${n.error}`))})}}const t="prayer",e="geocoding",n={PRAYER_TIMES:864e5,GEOCODING:6048e5};const a=new class{constructor(){this.memoryCache=new Map,this.idbCache=new IndexedDBCache("ummah-unified-cache","cache"),this.initialized=!1,this.initPromise=null}async init(){if(!this.initialized)return this.initPromise||(this.initPromise=this._doInit()),this.initPromise}async _doInit(){try{await this.idbCache.init(),this.initialized=!0}catch(t){this.initialized=!0}}generateKey(t,...e){return`${t}:${e.join(":")}`}generateLocationKey(t,e,n,...a){const i=e.toFixed(4),r=n.toFixed(4);return this.generateKey(t,i,r,...a)}async get(t){if(this.memoryCache.has(t)){const e=this.memoryCache.get(t);if(Date.now()-e.timestamp<e.ttl)return e.value;this.memoryCache.delete(t)}try{const e=await this.idbCache.get(t);if(null!==e)return this.memoryCache.set(t,{value:e,timestamp:Date.now(),ttl:n.PRAYER_TIMES}),e}catch(t){}return null}async set(t,e,a=n.PRAYER_TIMES){const i={value:e,timestamp:Date.now(),ttl:a};this.memoryCache.set(t,i);try{await this.idbCache.set(t,e,a)}catch(t){}}async delete(t){this.memoryCache.delete(t);try{await this.idbCache.delete(t)}catch(t){}}async invalidateNamespace(t){const e=t+":";for(const t of this.memoryCache.keys())t.startsWith(e)&&this.memoryCache.delete(t);try{const t=await this.idbCache.keys();for(const n of t)n.startsWith(e)&&await this.idbCache.delete(n)}catch(t){}}async clear(){this.memoryCache.clear();try{await this.idbCache.clear()}catch(t){}}async clearExpired(){let t=0;const e=Date.now();for(const[n,a]of this.memoryCache.entries())e-a.timestamp>=a.ttl&&(this.memoryCache.delete(n),t++);try{t+=await this.idbCache.clearExpired()}catch(t){}return t}async getStats(){const t=this.memoryCache.size;let e={totalEntries:0,validEntries:0,expiredEntries:0};try{e=await this.idbCache.getStats()}catch(t){}return{memoryEntries:t,...e,totalEntries:t+e.totalEntries}}async getOrFetch(t,e,n){const a=await this.get(t);if(null!==a)return a;const i=await e();return await this.set(t,i,n),i}async getOrFetchStale(t,e,n,a=.8*n){if(this.memoryCache.has(t)){const i=this.memoryCache.get(t),r=Date.now()-i.timestamp;if(r<i.ttl){const s=r>a;return s&&this._refreshInBackground(t,e,n),{value:i.value,isStale:s}}}try{const e=await this.idbCache.get(t);if(null!==e)return this.memoryCache.set(t,{value:e,timestamp:Date.now(),ttl:n}),{value:e,isStale:!0}}catch(t){}const i=await e();return await this.set(t,i,n),{value:i,isStale:!1}}async _refreshInBackground(t,e,n){try{const a=await e();await this.set(t,a,n)}catch(t){}}};"undefined"!=typeof window&&a.init().catch(console.warn);const i="darkMode",r={enableHighAccuracy:!1,timeout:1e4,maximumAge:3e5},s=["https://corsproxy.io/?","https://api.allorigins.win/raw?url="],o={latitude:-6.2088,longitude:106.8456,city:"Jakarta",country:"Indonesia"};function c(){const t=new URLSearchParams(window.location.search),e=t.get("institution"),n=t.get("jurisdiction");return e?{type:"institution",name:e}:n?{type:"jurisdiction",name:n}:{type:"global",name:"Global Feed"}}async function l(){const t=document.getElementById("prayer-times-widget");if(t){t.innerHTML='\n    <div class="prayer-widget-header">\n      <h3 class="prayer-widget-title">Prayer Time Widget</h3>\n    </div>\n    <div class="prayer-widget-loading">\n      <span class="loading-spinner"></span>\n      <span>Fetching your location...</span>\n    </div>\n  ';try{await a.init();const t=await async function(){if("denied"===await async function(){if(!navigator.permissions)return"prompt";try{return(await navigator.permissions.query({name:"geolocation"})).state}catch(t){return"prompt"}}())return{...o,isFallback:!0};return new Promise(t=>{navigator.geolocation?navigator.geolocation.getCurrentPosition(async i=>{const r={latitude:i.coords.latitude,longitude:i.coords.longitude,isFallback:!1};await async function(t){if(!t||t.isFallback)return;const i=a.generateLocationKey(e,t.latitude,t.longitude);try{const e=await a.get(i);if(e)return t.city=e.city,void(t.country=e.country)}catch(t){}const r=`https://nominatim.openstreetmap.org/reverse?format=json&lat=${t.latitude}&lon=${t.longitude}`;for(const e of s)try{const s=new AbortController,o=setTimeout(()=>s.abort(),5e3),c=await fetch(`${e}${encodeURIComponent(r)}`,{signal:s.signal});if(clearTimeout(o),!c.ok)continue;const l=await c.json();return t.city=l.address.city||l.address.town||l.address.village||l.address.county||"Unknown",t.country=l.address.country||"Unknown",void await a.set(i,{city:t.city,country:t.country},n.GEOCODING)}catch(t){}t.city="Unknown",t.country="Unknown"}(r),t(r)},e=>{let n="Unknown location error";switch(e.code){case e.PERMISSION_DENIED:n="Permission denied";break;case e.POSITION_UNAVAILABLE:n="Position unavailable";break;case e.TIMEOUT:n="Location request timed out";break;default:n=e.message||"Unknown error"}t({...o,isFallback:!0})},r):t({...o,isFallback:!0})})}(),i=await async function(t){const e=await async function(t){const e=d(t);if(!e)return null;try{const t=await a.get(e);if(t){const e=new Date(t.date),n=new Date;if(e.toDateString()===n.toDateString())return t.prayerTimes}}catch(t){}return null}(t);if(e)return e;const n=new Date,i=n.getDate(),r=n.getMonth()+1,s=n.getFullYear(),o=`https://api.aladhan.com/v1/timings/${i}-${r}-${s}?latitude=${t.latitude}&longitude=${t.longitude}&method=20`,c=await fetch(o),l=await c.json();if(200===l.code&&l.data){const e={Fajr:l.data.timings.Fajr,Dhuhr:l.data.timings.Dhuhr,Asr:l.data.timings.Asr,Maghrib:l.data.timings.Maghrib,Isha:l.data.timings.Isha};return await async function(t,e){const n=d(t);if(!n)return;try{const i={date:(new Date).toISOString(),prayerTimes:e,location:{latitude:t.latitude,longitude:t.longitude}},r=new Date,s=new Date(r.getFullYear(),r.getMonth(),r.getDate()+1).getTime()-r.getTime();await a.set(n,i,s)}catch(t){}}(t,e),e}throw new Error("Failed to fetch prayer times")}(t);u(t,i),setInterval(()=>{u(t,i)},1e3)}catch(e){t.innerHTML='<p class="text-center prayer-error">Unable to load prayer times.</p>'}}}function d(e){if(!e)return null;const n=new Date,i=`${n.getFullYear()}-${n.getMonth()+1}-${n.getDate()}`;return a.generateLocationKey(t,e.latitude,e.longitude,i)}function u(t,e){const n=document.getElementById("prayer-times-widget");if(!n)return;const a=(new Date).toLocaleDateString("en-US",{weekday:"short",month:"short",day:"numeric",year:"numeric"}),i=(new Date).toLocaleTimeString("en-US",{hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:!0}),{nextPrayer:r,timeToNext:s}=function(t){const e=new Date,n=60*e.getHours()+e.getMinutes(),a=[{name:"Fajr",time:t.Fajr},{name:"Dhuhr",time:t.Dhuhr},{name:"Asr",time:t.Asr},{name:"Maghrib",time:t.Maghrib},{name:"Isha",time:t.Isha}].map(t=>{const[e,n]=t.time.split(":").map(Number);return{name:t.name,time:t.time,minutes:60*e+n}});let i=null;for(const t of a)if(t.minutes>n){i=t;break}if(!i)return i=a[0],{nextPrayer:i,timeToNext:1440-n+i.minutes};return{nextPrayer:i,timeToNext:i.minutes-n}}(e),o=function(t){const e=Math.floor(t/60),n=t%60;return e>0?`${e}h ${n}m`:`${n}m`}(s),c=t.isFallback?" (Fallback)":"",l=t.isFallback?"prayer-widget-location prayer-widget-location-fallback":"prayer-widget-location";n.innerHTML=`\n    <div class="prayer-widget-header">\n      <h3 class="prayer-widget-title">Prayer Time Widget</h3>\n    </div>\n    <div class="prayer-widget-header">\n      <span class="prayer-widget-date">${a}</span>\n      <span class="prayer-widget-clock">${i}</span>\n    </div>\n    <div class="${l}">üìç ${t.city}, ${t.country}${c}</div>\n    <div class="prayer-widget-next">\n      <span class="prayer-widget-next-label">Next Prayer:</span> ${r.name} (${o})\n    </div>\n    <div class="prayer-widget-times">\n      <div class="prayer-widget-column">\n        <span class="prayer-widget-name">Fajr</span>\n        <span class="prayer-widget-time">${e.Fajr}</span>\n      </div>\n      <div class="prayer-widget-column">\n        <span class="prayer-widget-name">Dhuhr</span>\n        <span class="prayer-widget-time">${e.Dhuhr}</span>\n      </div>\n      <div class="prayer-widget-column">\n        <span class="prayer-widget-name">Asr</span>\n        <span class="prayer-widget-time">${e.Asr}</span>\n      </div>\n      <div class="prayer-widget-column">\n        <span class="prayer-widget-name">Maghrib</span>\n        <span class="prayer-widget-time">${e.Maghrib}</span>\n      </div>\n      <div class="prayer-widget-column">\n        <span class="prayer-widget-name">Isha</span>\n        <span class="prayer-widget-time">${e.Isha}</span>\n      </div>\n    </div>\n  `}async function h(t=!1){const e=c(),n=document.getElementById("prayer-times-widget");"institution"===e.type?await async function(t,e,n=!1){try{const{getInstitutionFeedConfig:a,getDocumentById:i}=await import("./config-BsZ8KEZg.js"),r=await a(t);if(r?.widget?.enabled?await l():e&&(e.style.display="none"),r?.carousel){n&&m();const t=await Promise.all(r.carousel.images.map(async t=>{const e=t.document_id?await i(t.document_id):null;return{...t,document:e}})),e={...r.carousel,images:t};y(e,r.carousel.post_to_jurisdictions?.[0]||"","institution")}}catch(t){}}(e.name,n,t):"jurisdiction"===e.type?await async function(t,e,n=!1){try{const{getJurisdictionFeedConfig:a,getJurisdictionCarousels:i}=await import("./config-BsZ8KEZg.js"),r=await a(t);r?.widget?.enabled?await l():e&&(e.style.display="none"),n&&m();(await i(t)).forEach(t=>{y(t,t.institution,"jurisdiction")})}catch(t){}}(e.name,n,t):await l()}function m(){const t=document.querySelector(".paper-sheet");if(!t)return;t.querySelectorAll(".feed-carousel").forEach(t=>t.remove())}function y(t,e,n){try{const a=document.querySelector(".paper-sheet");if(!a)return;const i="institution"===n?`Posted in ${e.replace(/\s*\[.*?\]\s*/g,"").trim()}`:`Posted by ${e.replace(/\s*\[.*?\]\s*/g,"").trim()}`,r=`carousel-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,s=`\n      <div class="feed-carousel" id="${r}">\n        <div class="carousel-header">\n          <h3 class="carousel-title">${t.title}</h3>\n        </div>\n        <div class="carousel-container">\n          <div class="carousel-track" id="${r}-track">\n            ${t.images.map((t,e)=>{const n=t.document?.title||"Untitled",a=t.document?.filename||"#";return`\n              <div class="carousel-slide">\n                <img src="${t.url}" alt="${n}" loading="${0===e?"eager":"lazy"}" decoding="async" fetchpriority="${0===e?"high":"auto"}">\n                <div class="carousel-caption">\n                  <a href="${a}" class="carousel-caption-link">${n}</a>\n                </div>\n              </div>\n            `}).join("")}\n          </div>\n          <button class="carousel-nav prev" aria-label="Previous slide">‚Äπ</button>\n          <button class="carousel-nav next" aria-label="Next slide">‚Ä∫</button>\n        </div>\n        <div class="carousel-footer">\n          <div class="carousel-indicators">\n            ${t.images.map((t,e)=>`\n              <button class="carousel-indicator ${0===e?"active":""}" data-index="${e}" aria-label="Go to slide ${e+1}"></button>\n            `).join("")}\n          </div>\n          <span class="carousel-source">${i}</span>\n        </div>\n      </div>\n    `;a.insertAdjacentHTML("beforeend",s),function(t,e){const n=document.getElementById(t);if(!n)return;const a=document.getElementById(`${t}-track`),i=n.querySelector(".carousel-nav.prev"),r=n.querySelector(".carousel-nav.next"),s=n.querySelectorAll(".carousel-indicator");let o,c=0;function l(t){t<0&&(t=e-1),t>=e&&(t=0),c=t,a.style.transform=`translateX(-${100*c}%)`,s.forEach((t,e)=>{t.classList.toggle("active",e===c)})}function d(){l(c+1)}function u(){l(c-1)}function h(){o=setInterval(d,5e3)}function m(){clearInterval(o)}function y(){m(),h()}i.addEventListener("click",()=>{u(),y()}),r.addEventListener("click",()=>{d(),y()}),s.forEach((t,e)=>{t.addEventListener("click",()=>{l(e),y()})}),h(),n.addEventListener("mouseenter",m),n.addEventListener("mouseleave",h);let g=0,w=0;function p(){const t=50,e=g-w;Math.abs(e)>t&&(e>0?d():u())}n.addEventListener("touchstart",t=>{g=t.changedTouches[0].screenX,m()},{passive:!0}),n.addEventListener("touchend",t=>{w=t.changedTouches[0].screenX,p(),h()},{passive:!0})}(r,t.images.length)}catch(t){}}document.addEventListener("DOMContentLoaded",()=>{!function(){const t=document.querySelector(".admin-seal");if(!t)return;const e=localStorage.getItem(i),n=window.matchMedia("(prefers-color-scheme: dark)").matches;("true"===e||!e&&n)&&document.documentElement.classList.add("dark"),t.addEventListener("click",()=>{document.documentElement.classList.toggle("dark");const t=document.documentElement.classList.contains("dark");localStorage.setItem(i,t)})}(),function(){const t=c(),e=document.getElementById("feed-header");if(e)if("global"===t.type)e.textContent="Global Feed";else if("institution"===t.type){const n=t.name.replace(/\s*\[.*?\]\s*/g,"").trim();e.textContent=`${n} Feed`}else if("jurisdiction"===t.type){const n=t.name.replace(/\s*\[.*?\]\s*/g,"").trim();e.textContent=`${n} Feed`}}(),h(!1)}),window.addEventListener("pageshow",t=>{t.persisted&&h(!0)});
