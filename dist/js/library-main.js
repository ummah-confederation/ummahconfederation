const t="1.0.0";let n=null,e=null,i=null,o=null;let a={documents:0,institutions:0,jurisdictions:0,squircleIcons:0};function s(t){const n=Date.now();return a[t]&&n-a[t]<3e5}function c(t){a[t]=Date.now()}async function r(n,e=!0){const i=e?`?v=${t}&t=${Date.now()}`:`?t=${Date.now()}`;return fetch(n+i,{cache:"no-store",headers:{Accept:"application/json"}})}async function l(){if(n&&s("documents"))return n;try{const t=await r("config/documents-config.json");if(!t.ok)throw new Error(`Failed to load config: ${t.status} ${t.statusText}`);const e=await t.json();return n=e,c("documents"),e}catch(t){throw t}}async function d(){if(e&&s("institutions"))return e;try{const t=await r("config/institution-config.json");if(!t.ok)throw new Error(`Failed to load institution config: ${t.status} ${t.statusText}`);const n=await t.json();return e=n,c("institutions"),n}catch(t){return{institutions:{}}}}async function u(){if(i&&s("jurisdictions"))return i;try{const t=await r("config/jurisdiction-config.json");if(!t.ok)throw new Error(`Failed to load jurisdiction config: ${t.status} ${t.statusText}`);const n=await t.json();return i=n,c("jurisdictions"),n}catch(t){return{jurisdictions:{}}}}async function m(t){const n=await d();return n.institutions?.[t]||null}async function f(){return(await l()).documents.filter(t=>!1!==t.visible)}async function p(){if(o&&s("squircleIcons"))return o;try{const t=await r("config/squircle-icons-config.json");if(!t.ok)throw new Error(`Failed to load squircle icons config: ${t.status} ${t.statusText}`);const n=await t.json();return o=n,c("squircleIcons"),n}catch(t){return{icons:{}}}}function v(){n=null,e=null,i=null,o=null,a={documents:0,institutions:0,jurisdictions:0,squircleIcons:0}}async function y(t,n){const e=(await f()).filter(e=>"Feed"===e.item&&("institution"===t?e.institution===n:"jurisdiction"===t&&e.jurisdiction===n));return await Promise.all(e.map(async t=>{const n=t.carousel?.linked_document_id?await async function(t){return(await l()).documents.find(n=>n.id===t)||null}(t.carousel.linked_document_id):null;return{...t,linkedDocument:n}}))}function h(){const t=new URLSearchParams(window.location.search);return{item:t.get("item"),institution:t.get("institution"),jurisdiction:t.get("jurisdiction")}}function b(){const t=window.location.hash.slice(1);if(!t)return{item:null,institution:null,jurisdiction:null};const n=new URLSearchParams(t);return{item:n.get("item"),institution:n.get("institution"),jurisdiction:n.get("jurisdiction")}}function w(t,n){const e=[...t];switch(n){case"name":return e.sort((t,n)=>t.title.localeCompare(n.title));case"version":return e.sort((t,n)=>{const e=n.version-t.version;return 0!==e?e:new Date(n.date)-new Date(t.date)});case"date":return e.sort((t,n)=>new Date(n.date)-new Date(t.date));default:return e}}function g(t,n){return t.filter(t=>(!n.item||t.item.toLowerCase()===n.item.toLowerCase())&&((!n.institution||t.institution.toLowerCase()===n.institution.toLowerCase())&&(!n.jurisdiction||t.jurisdiction.toLowerCase()===n.jurisdiction.toLowerCase())))}function $(t){const n=document.createElement("div");return n.textContent=t,n.innerHTML}"undefined"!=typeof window&&(window.clearConfigCache=v,window.getCacheVersion=function(){return t},window.setCacheVersion=function(t){v()});const L={profileType:null,profileName:null,currentFilter:"Feed",documents:[],profileData:null,availableTypes:[]};let E=null;function j(t){const n=t.match(/^(.+?)\s*\[(.*?)\]\s*$/);return n?{name:n[1].trim(),label:n[2].trim()}:{name:t.trim(),label:""}}function x(){let t=h();return t.institution||t.jurisdiction||(t=b()),t.institution?{type:"institution",name:t.institution}:t.jurisdiction?{type:"jurisdiction",name:t.jurisdiction}:null}async function C(t){E=t;const n=x();if(!n)return void function(){const t=document.getElementById("profile-container");t&&t.classList.add("hidden")}();L.profileType=n.type,L.profileName=n.name;const e=await f();var i;L.documents=e.filter(t=>"institution"===L.profileType?t.institution===L.profileName:t.jurisdiction===L.profileName),L.availableTypes=(i=L.documents,["all",...[...new Set(i.map(t=>t.item))].sort((t,n)=>t.localeCompare(n))]),L.availableTypes.includes("Feed")?L.currentFilter="Feed":L.currentFilter="all","institution"===L.profileType?L.profileData=await m(L.profileName):L.profileData=await async function(t){const n=await u();return n.jurisdictions?.[t]||null}(L.profileName),function(){!function(){const t=document.getElementById("profile-container");t&&t.classList.remove("hidden")}();const t=document.getElementById("profile-header");if(!t)return;const{name:n,label:e}=j(L.profileName),i=L.profileData||{},o=i.cover||"./images/default-cover.jpg",a=i.avatar||"./images/default-avatar.webp",s=i.bio||"";let c="";if("institution"===L.profileType){const t=function(t,n){return t.filter(t=>t.institution===n).length}(L.documents,L.profileName);c=`${t} Contributions`}else{const t=function(t,n){return new Set(t.filter(t=>t.jurisdiction===n).map(t=>t.institution)).size}(L.documents,L.profileName);c=`${t} Contributors`}const r="institution"===L.profileType?"Contact":"Contributors";t.innerHTML=`\n    <div class="profile-cover">\n      <img src="${$(o)}" alt="Cover" loading="lazy" decoding="async" />\n    </div>\n    <div class="profile-info">\n      <div class="profile-header-row">\n        <div class="profile-avatar">\n          <img src="${$(a)}" alt="${$(n)}" loading="eager" fetchpriority="high" />\n        </div>\n        <div class="profile-actions">\n          <button class="profile-button" id="profile-action-btn">${$(r)}</button>\n        </div>\n      </div>\n      <div class="profile-details-section">\n        <h1 class="profile-name">${$(n)}</h1>\n        ${e?`<span class="profile-label">${$(e)}</span>`:""}\n        <span class="profile-count">${$(c)}</span>\n        ${s?`<p class="profile-bio">${$(s)}</p>`:""}\n      </div>\n    </div>\n  `;const l=document.getElementById("profile-action-btn");l&&l.addEventListener("click",I)}(),function(){const t=document.getElementById("profile-filters");if(!t)return;const n=L.availableTypes;t.innerHTML=`\n    <div class="filter-pills-container">\n      ${n.map(t=>{return`\n        <button \n          class="filter-pill ${t===L.currentFilter?"active":""}" \n          data-type="${$(t)}"\n        >\n          <span class="filter-pill-icon">\n            ${function(t){return{all:"üìÇ",feed:"üì∞",book:"üìö",guideline:"üíé",policy:"üìã",decision:"‚ÑπÔ∏è",verdict:"‚öñÔ∏è",note:"üìé"}[t.toLowerCase()]||"üìÑ"}(t)}\n          </span>\n          <span class="filter-pill-label">${$((n=t,n.charAt(0).toUpperCase()+n.slice(1)))}</span>\n        </button>\n      `;var n}).join("")}\n    </div>\n  `,t.querySelectorAll(".filter-pill").forEach(t=>{t.addEventListener("click",()=>{!function(t){L.currentFilter=t,document.querySelectorAll(".filter-pill").forEach(n=>{n.classList.toggle("active",n.dataset.type===t)}),E&&E(t)}(t.dataset.type)})})}()}function k(){return L.currentFilter}function T(){return"all"===L.currentFilter?L.documents.filter(t=>"Feed"!==t.item):"feed"===L.currentFilter.toLowerCase()?[]:L.documents.filter(t=>t.item.toLowerCase()===L.currentFilter.toLowerCase())}function I(){"institution"===L.profileType?async function(){const t=L.profileData||{},{name:n,label:e}=j(L.profileName),i=t.contact||{},o=document.getElementById("profile-modal-overlay"),a=document.getElementById("modal-title"),s=document.getElementById("modal-content");if(!o||!a||!s)return;a.textContent="Contact Information";const c=t.avatar||"./images/default-avatar.webp";s.innerHTML=`\n    <div class="contact-card">\n      <div class="contact-card-header">\n        <img src="${$(c)}" alt="${$(n)}" class="contact-card-avatar" loading="lazy" decoding="async" />\n        <div>\n          <div class="contact-card-name">${$(n)}</div>\n          ${e?`<div class="contact-card-label">${$(e)}</div>`:""}\n        </div>\n      </div>\n      ${i.email?`\n        <div class="contact-info-item">\n          <span class="contact-info-icon">üìß</span>\n          <div>\n            <div class="contact-info-label">Email</div>\n            <div class="contact-info-value">\n              <a href="mailto:${$(i.email)}">${$(i.email)}</a>\n            </div>\n          </div>\n        </div>\n      `:""}\n      ${i.phone?`\n        <div class="contact-info-item">\n          <span class="contact-info-icon">üì±</span>\n          <div>\n            <div class="contact-info-label">Phone</div>\n            <div class="contact-info-value">\n              <a href="tel:${$(i.phone.replace(/\s/g,""))}">${$(i.phone)}</a>\n            </div>\n          </div>\n        </div>\n      `:""}\n      ${i.address?`\n        <div class="contact-info-item">\n          <span class="contact-info-icon">üìç</span>\n          <div>\n            <div class="contact-info-label">Address</div>\n            <div class="contact-info-value">${$(i.address)}</div>\n          </div>\n        </div>\n      `:""}\n      ${i.website?`\n        <div class="contact-info-item">\n          <span class="contact-info-icon">üåê</span>\n          <div>\n            <div class="contact-info-label">Website</div>\n            <div class="contact-info-value">\n              <a href="${$(i.website)}" target="_blank" rel="noopener noreferrer">${$(i.website)}</a>\n            </div>\n          </div>\n        </div>\n      `:""}\n      ${i.email||i.phone||i.address||i.website?"":'\n        <div class="contact-info-item">\n          <span class="contact-info-icon">‚ÑπÔ∏è</span>\n          <div class="contact-info-value">No contact information available</div>\n        </div>\n      '}\n    </div>\n  `,o.classList.add("active")}():async function(){j(L.profileName);const t=document.getElementById("profile-modal-overlay"),n=document.getElementById("modal-title"),e=document.getElementById("modal-content");if(!t||!n||!e)return;n.textContent="Contributors";const i=function(t){const n=new Map;return L.documents.forEach(e=>{if(e.jurisdiction===t){const t=e.institution;n.set(t,(n.get(t)||0)+1)}}),Array.from(n.entries()).map(([t,n])=>({name:t,count:n})).sort((t,n)=>n.count-t.count)}(L.profileName);if(0===i.length)e.innerHTML='\n      <div class="contact-info-item">\n        <span class="contact-info-icon">‚ÑπÔ∏è</span>\n        <div class="contact-info-value">No contributors found</div>\n      </div>\n    ';else{const t=await Promise.all(i.map(async t=>{const n=await m(t.name),e=n?.avatar||"./images/default-avatar.webp",{name:i}=j(t.name);return`\n          <div class="contributor-item">\n            <img src="${$(e)}" alt="${$(i)}" class="contributor-avatar" loading="lazy" decoding="async" />\n            <div class="contributor-info">\n              <div class="contributor-name">${$(i)}</div>\n              <div class="contributor-count">${t.count} contribution${1!==t.count?"s":""}</div>\n            </div>\n            <a href="?institution=${encodeURIComponent(t.name)}" class="contributor-link">View</a>\n          </div>\n        `}));e.innerHTML=`\n      <div class="contributor-list">\n        ${t.join("")}\n      </div>\n    `}t.classList.add("active")}()}function N(){const t=document.getElementById("profile-modal-overlay");t&&t.classList.remove("active")}async function B(t){if(!t)return;const n=await y(L.profileType,L.profileName);if(0===n.length)return void(t.innerHTML='<p class="text-center" style="padding: 2rem; opacity: 0.6;">No feed items found.</p>');let e;if("jurisdiction"===L.profileType){const t=new Map;n.forEach(n=>{const e=n.institution;t.has(e)||t.set(e,[]),t.get(e).push(n)}),e=Array.from(t.entries()).map(([t,n])=>({title:n[0]?.title||t.replace(/\s*\[.*?\]\s*/g,"").trim(),sourceLabel:`Posted by ${t.replace(/\s*\[.*?\]\s*/g,"").trim()}`,docs:n}))}else{const t=n[0]?.jurisdiction?.replace(/\s*\[.*?\]\s*/g,"").trim()||"";e=[{title:n[0]?.title||"Feed",sourceLabel:`Posted in ${t}`,docs:n}]}t.innerHTML="",e.forEach(n=>{const e=`carousel-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,i=n.docs.map((t,n)=>({caption:t.linkedDocument?.title||t.title||"Untitled",docLink:t.linkedDocument?.filename||"#",imageUrl:t.carousel?.image||"",index:n})),o=`\n      <div class="feed-carousel" id="${e}">\n        <div class="carousel-header">\n          <h3 class="carousel-title">${$(n.title)}</h3>\n        </div>\n        <div class="carousel-container">\n          <div class="carousel-track" id="${e}-track">\n            ${i.map(t=>`\n              <div class="carousel-slide">\n                <img src="${$(t.imageUrl)}" alt="${$(t.caption)}" loading="${0===t.index?"eager":"lazy"}" decoding="async" fetchpriority="${0===t.index?"high":"auto"}">\n                <div class="carousel-caption">\n                  <a href="${$(t.docLink)}" class="carousel-caption-link">${$(t.caption)}</a>\n                </div>\n              </div>\n            `).join("")}\n          </div>\n          <button class="carousel-nav prev" aria-label="Previous slide">‚Äπ</button>\n          <button class="carousel-nav next" aria-label="Next slide">‚Ä∫</button>\n        </div>\n        <div class="carousel-footer">\n          <div class="carousel-indicators">\n            ${i.map(t=>`\n              <button class="carousel-indicator ${0===t.index?"active":""}" data-index="${t.index}" aria-label="Go to slide ${t.index+1}"></button>\n            `).join("")}\n          </div>\n          <span class="carousel-source">${$(n.sourceLabel)}</span>\n        </div>\n      </div>\n    `;t.insertAdjacentHTML("beforeend",o),function(t,n){const e=document.getElementById(t);if(!e)return;const i=document.getElementById(`${t}-track`),o=e.querySelector(".carousel-nav.prev"),a=e.querySelector(".carousel-nav.next"),s=e.querySelectorAll(".carousel-indicator");let c,r=0;function l(t){t<0&&(t=n-1),t>=n&&(t=0),r=t,i.style.transform=`translateX(-${100*r}%)`,s.forEach((t,n)=>{t.classList.toggle("active",n===r)})}function d(){l(r+1)}function u(){l(r-1)}function m(){c=setInterval(d,5e3)}function f(){clearInterval(c)}function p(){f(),m()}o.addEventListener("click",()=>{u(),p()}),a.addEventListener("click",()=>{d(),p()}),s.forEach((t,n)=>{t.addEventListener("click",()=>{l(n),p()})}),m(),e.addEventListener("mouseenter",f),e.addEventListener("mouseleave",m);let v=0,y=0;e.addEventListener("touchstart",t=>{v=t.changedTouches[0].screenX},{passive:!0}),e.addEventListener("touchend",t=>{y=t.changedTouches[0].screenX;const n=v-y;Math.abs(n)>50&&(n>0?d():u(),p())},{passive:!0})}(e,i.length)})}!function(){const t=document.getElementById("profile-modal-overlay"),n=document.getElementById("modal-close");n&&n.addEventListener("click",N),t&&t.addEventListener("click",n=>{n.target===t&&N()}),document.addEventListener("keydown",t=>{"Escape"===t.key&&N()})}();let M="name",F=[],D=!1;function S(t){const n=document.getElementById("library");if(!n)return;const e=x(),i="institution"===e?.type,o=i||"jurisdiction"===e?.type;n.innerHTML="";let a="";if(o){const t="library-grid-profile";a=i?`\n<div class="library-row library-header ${t} gap-3 items-baseline text-left font-bold border-b border-black pb-1 mb-3">\n  <span class="overflow-hidden text-ellipsis whitespace-nowrap">Title</span>\n  <span class="text-right whitespace-nowrap">Posted in</span>\n</div>`:`\n<div class="library-row library-header ${t} gap-3 items-baseline text-left font-bold border-b border-black pb-1 mb-3">\n  <span class="overflow-hidden text-ellipsis whitespace-nowrap">Title</span>\n  <span class="text-right whitespace-nowrap">Posted by</span>\n</div>`}else{a=`\n<div class="library-row library-header ${"library-grid-default"} gap-4 items-start text-left font-bold border-b border-black pb-1 mb-3">\n  <span class="overflow-hidden text-ellipsis whitespace-nowrap">Title</span>\n  <span class="text-center tabular-nums">Version</span>\n  <span class="text-right whitespace-nowrap">Updated Date</span>\n</div>`}n.innerHTML=a,t.forEach(t=>{const e=function(t){const n=x(),e="institution"===n?.type,i="jurisdiction"===n?.type,o=e||i,a=document.createElement("div"),s=o?"library-grid-profile":"library-grid-default";a.className=`library-row ${s} gap-3 items-start border-b border-gray-200 py-2`,a.dataset.name=t.title,a.dataset.version=t.version,a.dataset.date=t.date,a.dataset.item=t.item,a.dataset.institution=t.institution,a.dataset.jurisdiction=t.jurisdiction;const c=document.createElement("span");c.className="overflow-hidden text-ellipsis whitespace-nowrap min-w-0";const r=document.createElement("a");r.href=t.filename,r.textContent=t.title,r.className="block overflow-hidden text-ellipsis whitespace-nowrap",c.appendChild(r);const l=document.createElement("span");if(e){l.className="library-metadata text-right whitespace-nowrap overflow-hidden text-sm text-ellipsis shrink-0";const n=(t.jurisdiction||"").replace(/\s*\[.*?\]\s*/g,""),e=t.jurisdiction?`?jurisdiction=${encodeURIComponent(t.jurisdiction)}`:"#";l.innerHTML=`<span class="sm:hidden">Posted in </span><a href="${$(e)}" class="library-profile-link">${$(n)}</a>`}else{if(!i){const n=document.createElement("span");n.className="library-version text-center text-sm   tabular-nums",n.innerHTML=`<span class="sm:hidden text-sm">Version </span>${t.version}`;const e=document.createElement("span");return e.className="library-date text-right whitespace-nowrap",e.textContent=t.dateFormatted,a.appendChild(c),a.appendChild(n),a.appendChild(e),a}{l.className="library-metadata text-right whitespace-nowrap overflow-hidden text-sm text-ellipsis shrink-0";const n=(t.institution||"").replace(/\s*\[.*?\]\s*/g,""),e=t.institution?`?institution=${encodeURIComponent(t.institution)}`:"#";l.innerHTML=`<span class="sm:hidden">Posted by </span><a href="${$(e)}" class="library-profile-link">${$(n)}</a>`}}return a.appendChild(c),a.appendChild(l),a}(t);n.appendChild(e)})}function q(t){document.querySelectorAll(".sort-controls button").forEach(n=>{n.classList.remove("active"),n.dataset.sort===t&&n.classList.add("active")})}async function H(t={},n=null){try{D=!!n||!!x(),D?document.body.classList.add("has-profile"):document.body.classList.remove("has-profile");const e=document.querySelector(".sort-controls-wrapper");e&&(D?e.classList.add("hidden"):e.classList.remove("hidden"));const i=document.getElementById("library-context");if(i&&(D?i.classList.add("hidden"):i.classList.remove("hidden")),0===F.length){const n=await f();F=g(n,t),F=w(F,M)}S(F),function(t){const n=document.getElementById("library-context");if(!n)return;const e=[];t.item&&e.push(t.item),t.institution&&e.push(t.institution),t.jurisdiction&&e.push(t.jurisdiction),0===e.length&&e.push("All"),n.textContent=e.join(" ¬∑ ")}(t),q(M),D||document.querySelectorAll(".sort-controls button").forEach(t=>{t.addEventListener("click",()=>{const n=t.dataset.sort;var e;n&&(M=e=n,F=w(F,e),S(F),q(e))})})}catch(t){!function(t){const n=document.createElement("div");n.className="error-message",n.style.cssText="\n    background: #fee;\n    border: 1px solid #fcc;\n    color: #c00;\n    padding: 1rem;\n    margin: 1rem;\n    border-radius: 4px;\n    text-align: center;\n  ",n.textContent=t,document.body.insertBefore(n,document.body.firstChild),setTimeout(()=>{n.remove()},5e3)}("Unable to load document library. Please try again later.")}}const P="darkMode";document.addEventListener("DOMContentLoaded",async()=>{!function(){const t=document.querySelector(".admin-seal");if(!t)return;const n=localStorage.getItem(P),e=window.matchMedia("(prefers-color-scheme: dark)").matches;("true"===n||!n&&e)&&document.documentElement.classList.add("dark"),t.addEventListener("click",()=>{document.documentElement.classList.toggle("dark");const t=document.documentElement.classList.contains("dark");localStorage.setItem(P,t)})}(),await async function(){const[t,n,e,i]=await Promise.all([l(),d(),u(),p()]);return{documents:t,institutions:n,jurisdictions:e,squircleIcons:i}}();const t=await f();let n=h();n.institution||n.jurisdiction||n.item||(n=b());const e=x(),i=g(t,n);let o=i;if(e){await C(async()=>{if("feed"===k().toLowerCase()){const t=document.getElementById("library");return void(t&&await B(t))}const t=T(),n=new Set(t.map(t=>t.id)),e=i.filter(t=>n.has(t.id));F=w(e,M),S(F),q(M)});const t=T(),n=new Set(t.map(t=>t.id));o=i.filter(t=>n.has(t.id))}if(o=w(o,"name"),F=o,await H(n,e),e){if("feed"===k().toLowerCase()){const t=document.getElementById("library");t&&await B(t)}}});
